<p>As you might know I’m working on shell that you can find the source code for <a href="https://github.com/mgattozzi/Rusty">here</a>.
I’ve been trying to implement pipes for the longest time and just have never
gotten them to work in Rust for whatever reason. I detail that in <a href="https://www.reddit.com/r/rust/comments/3azfie/how_to_pipe_one_process_into_another/">post</a> I put
in the rust subreddit today. I even managed to find a solution for it today
though it does use an unsafe block which I’m not exactly happy about but for
now it works until I find a safer way to do this. Here’s the code:</p>

<div class="highlight"><pre><code class="language-rust" data-lang="rust"><span class="kn">use</span> <span class="n">std</span><span class="o">::</span><span class="n">process</span><span class="o">::*</span><span class="p">;</span>
<span class="kn">use</span> <span class="n">std</span><span class="o">::</span><span class="n">os</span><span class="o">::</span><span class="n">unix</span><span class="o">::</span><span class="n">io</span><span class="o">::</span><span class="n">AsRawFd</span><span class="p">;</span>
<span class="kn">use</span> <span class="n">std</span><span class="o">::</span><span class="n">os</span><span class="o">::</span><span class="n">unix</span><span class="o">::</span><span class="n">io</span><span class="o">::</span><span class="n">FromRawFd</span><span class="p">;</span>
	<span class="cp">#[test]</span>
	<span class="k">fn</span> <span class="n">pipes</span><span class="p">(){</span>
		<span class="c1">//The stdout function makes sure that ouput</span>
		<span class="c1">//is piped and a child process is spawned</span>
		<span class="c1">//so that the right conversions can take </span>
		<span class="c1">//place in the following unsafe block</span>
		<span class="kd">let</span> <span class="n">cmd</span> <span class="o">=</span> <span class="n">Command</span><span class="o">::</span><span class="n">new</span><span class="p">(</span><span class="s">&quot;ls&quot;</span><span class="p">).</span><span class="n">arg</span><span class="p">(</span><span class="s">&quot;/&quot;</span><span class="p">)</span>
				<span class="p">.</span><span class="n">stdout</span><span class="p">(</span><span class="n">Stdio</span><span class="o">::</span><span class="n">piped</span><span class="p">())</span> 
				<span class="p">.</span><span class="nb">spawn</span><span class="p">();</span>			
		<span class="k">unsafe</span><span class="p">{</span> 
			<span class="c1">//Makes cmd into a raw fd that the Stdio </span>
			<span class="c1">//struct can read from and then make it </span>
			<span class="c1">//act as the input for the command that</span>
			<span class="c1">//is executed.</span>
			<span class="kd">let</span> <span class="n">cmd2</span> <span class="o">=</span> <span class="n">Command</span><span class="o">::</span><span class="n">new</span><span class="p">(</span><span class="s">&quot;grep&quot;</span><span class="p">).</span><span class="n">arg</span><span class="p">(</span><span class="s">&quot;etc&quot;</span><span class="p">)</span>
				<span class="p">.</span><span class="n">stdin</span><span class="p">(</span><span class="n">Stdio</span><span class="o">::</span><span class="n">from_raw_fd</span><span class="p">(</span><span class="n">cmd</span> 
				<span class="p">.</span><span class="n">ok</span><span class="p">().</span><span class="n">unwrap</span><span class="p">()</span>				 
				<span class="p">.</span><span class="n">stdout</span><span class="p">.</span><span class="n">unwrap</span><span class="p">()</span>			
				<span class="p">.</span><span class="n">as_raw_fd</span><span class="p">()))</span>			
				<span class="p">.</span><span class="n">output</span><span class="p">().</span><span class="n">ok</span><span class="p">();</span>		
			<span class="n">assert_eq</span><span class="o">!</span><span class="p">(</span><span class="s">&quot;etc&quot;</span><span class="p">,</span><span class="n">String</span><span class="o">::</span><span class="n">from_utf8</span><span class="p">(</span><span class="n">cmd2</span>
			<span class="p">.</span><span class="n">unwrap</span><span class="p">()).</span><span class="n">unwrap</span><span class="p">().</span><span class="n">trim</span><span class="p">());</span>
		<span class="p">}</span>
	<span class="p">}</span></code></pre></div>

<p>This was a test so using ok() and unwrap() is alright as I know what the inputs
are though I would suggest that not being the case usually. I still have some
places in my own code where I need to clean that up but did this so that
I could get it working as a proof of concept.</p>

<h3 id="conclusion">Conclusion</h3>
<p>It seems at this point in time piping processes might be unsafe. There is
a work around using raw fd (there are equivalent methods for Windows if you
need them) as a way to pipe the outputs of one program call into the input of
another. Sadly Rust’s documentation is a bit lacking in the matter. Hopefully
this will be of use to someone if they need to do this in the future.</p>

<p>Other Relevant Links:</p>

<ul>
  <li><a href="https://doc.rust-lang.org/std/process/struct.Stdio.html">Stdio Docs</a></li>
  <li><a href="https://doc.rust-lang.org/std/process/struct.Command.html">Command Docs</a></li>
</ul>
